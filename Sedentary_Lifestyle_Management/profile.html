<script>
    // ... (其他 profile.html 腳本內容)

    // 驗證並計算 TDEE 的函式
    window.saveProfile = function() {
        const gender = document.getElementById('gender').value;
        const weight = parseFloat(document.getElementById('weight').value); // kg
        const height = parseFloat(document.getElementById('height').value); // cm
        const age = parseFloat(document.getElementById('age').value);
        const activity = document.getElementById('activity').value; // 活動係數

        if (!weight || !height || !age || !activity) {
            alert("Please fill in all profile fields.");
            return;
        }

        // 1. 計算基礎代謝率 (BMR) - 使用 Mifflin-St Jeor 公式
        let bmr = 0;
        if (gender === 'male') {
            bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
        } else { // female
            bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
        }

        // 2. 應用活動係數計算 TDEE
        let activityFactor = 1.2;
        switch (activity) {
            case 'light': activityFactor = 1.375; break;
            case 'moderate': activityFactor = 1.55; break;
            case 'heavy': activityFactor = 1.725; break;
            case 'very_heavy': activityFactor = 1.9; break;
        }
        
        const tdee = bmr * activityFactor;

        // 3. 儲存到 localStorage
        localStorage.setItem('profileSaved', 'true');
        localStorage.setItem('gender', gender);
        localStorage.setItem('weight', weight);
        localStorage.setItem('height', height);
        localStorage.setItem('age', age);
        localStorage.setItem('activity', activity);
        localStorage.setItem('tdee', tdee.toFixed(0)); // 儲存 TDEE (每日應攝取熱量)

        alert(`Profile saved! Your estimated TDEE is ${tdee.toFixed(0)} kcal.`);
        showToast('Profile saved successfully!');
    }
    
    // ... (其他 profile.html 腳本內容)
</script>