<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diet Tracker</title>
    <link rel="stylesheet" href="style.css"> 
    <style>
        .header-bar { background-color: transparent; }
        .food-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: default; /* ç§»é™¤é»æ“Šæ¨£å¼ */
        }
    </style>
</head>
<body>
    <div id="overlay" onclick="closeNav()"></div>
    <div id="toast"></div>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="index.html">ğŸ“Š Dashboard</a>
        <a href="profile.html">ğŸ‘¤ User Profile</a>
        <a href="diet.html" style="color: white;">ğŸ Diet Tracker</a>
        <a href="walking.html">ğŸ‘£ Walking</a>
        <a href="water.html">ğŸ’§ Water Tracker</a>
        <a href="sedentary.html">ğŸª‘ Sedentary Timer</a>
        <a href="stairs.html">ğŸªœ Stairs Tracker</a>
        <a href="sleep.html">ğŸ˜´ Sleep Manager</a>
        <a href="exercise.html">ğŸƒ Exercise</a>
    </div>

    <div class="header-bar">
        <span class="menu-icon" onclick="openNav()">&#9776;</span>
    </div>

    <div class="container" style="margin-top: 0;">
        <h2>ğŸ Diet Tracker</h2>
        
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
        <p style="text-align: right; margin-top: 5px;">
            <span id="current-cal" style="font-weight: bold; color: #e67e22;">0</span> kcal / <span id="target-cal" style="color: #666;">--</span> kcal 
            <span id="status-text" style="font-size: small;"></span>
        </p>
        
        <div class="card" style="margin-top: 20px;">
            <h3>ğŸ” Search & Add Food</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="alert('æ›´æ–°åŠŸèƒ½ç›®å‰å·²ç¦ç”¨ï¼Œè‹¥éœ€æ›´æ–°è³‡æ–™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡æˆ–åœ¨çµ‚ç«¯æ©Ÿæ‰‹å‹•åŸ·è¡Œ Python è…³æœ¬ã€‚')">âš¡ Update DB</button>
            </div>
            
            <input type="text" id="search-box" placeholder="Enter food name (Chinese or English)" onkeyup="filterFood()">
            
            <div id="food-search-results">
                <div style="text-align:center; color:#999; margin-top:20px;">Start typing to search food...</div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>ğŸ—“ï¸ Today's Log</h3>
            <div id="food-log">
                <div style="text-align:center; color:#999; margin-top:20px;">No food logged yet.</div>
            </div>
            <button onclick="clearFoodLog()" class="danger-btn" style="margin-top: 15px;">Clear Log</button>
        </div>
        
    </div>

    <script>
        // --- å°èˆªåˆ—èˆ‡é€šç”¨åŠŸèƒ½ ---
        function openNav() {
            document.getElementById("mySidenav").style.width = "250px";
            document.getElementById("overlay").style.display = "block";
        }

        function closeNav() {
            document.getElementById("mySidenav").style.width = "0";
            document.getElementById("overlay").style.display = "none";
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // --- æ ¸å¿ƒé£²é£Ÿè¿½è¹¤é‚è¼¯ ---
        let foodDatabase = []; // å„²å­˜å¾ JSON è¼‰å…¥çš„é£Ÿç‰©è³‡æ–™
        let todayFoods = [];   // å„²å­˜ä»Šæ—¥å·²è¨˜éŒ„çš„é£Ÿç‰©
        let foodLog = document.getElementById('food-log');
        let foodSearchResults = document.getElementById('food-search-results');

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            loadFoodDatabase();
            loadFoodLog();
            updateDashboard();
        });

        // 1. è¼‰å…¥é£Ÿç‰©è³‡æ–™åº« (å¾ food_database.json è®€å–)
        function loadFoodDatabase() {
            foodSearchResults.innerHTML = '<div style="text-align:center; color:#007bff; margin-top:20px;">Loading database...</div>';
            
            // ğŸš¨ é€™æ˜¯é—œéµï¼ç¢ºä¿è·¯å¾‘æ­£ç¢º
            fetch('./food_database.json') 
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    foodDatabase = data;
                    console.log('Food database loaded successfully! Total items:', foodDatabase.length);
                    foodSearchResults.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">Start typing to search food...</div>';
                })
                .catch(error => {
                    console.error('Error fetching or parsing food database:', error);
                    foodSearchResults.innerHTML = `<div style="text-align:center; color:red; margin-top:20px;">ğŸš¨ Error loading database! (${error.message})</div>`;
                });
        }
        
        // 2. æœå°‹å‡½æ•¸ (Search Handler)
        window.filterFood = function() {
            const query = document.getElementById('search-box').value.toLowerCase().trim();
            if (query.length < 1) {
                displaySearchResults([]);
                return;
            }

            const filtered = foodDatabase.filter(food => {
                // æœå°‹ä¸­æ–‡ (zh) æˆ– è‹±æ–‡ (en) æ¬„ä½
                return (food.zh && food.zh.toLowerCase().includes(query)) ||
                       (food.en && food.en.toLowerCase().includes(query));
            });

            displaySearchResults(filtered.slice(0, 15)); // åªé¡¯ç¤ºå‰ 15 ç­†çµæœ
        }
        
        // 3. é¡¯ç¤ºçµæœå‡½æ•¸
        function displaySearchResults(results) {
            foodSearchResults.innerHTML = '';
            
            if (results.length === 0 && document.getElementById('search-box').value.length > 0) {
                foodSearchResults.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">No results found.</div>';
                return;
            }
            
            results.forEach(food => {
                const div = document.createElement('div');
                div.className = 'food-list-item clickable';
                
                // é¡¯ç¤ºä¸­è‹±æ–‡åç¨±
                const displayName = `${food.zh} ${food.en ? `(${food.en})` : ''}`;
                
                div.innerHTML = `<div><div style="font-weight:bold;">${displayName}</div></div><div style="display:flex; align-items:center; gap:10px;"><span style="color:#e67e22; font-weight:bold;">${food.cal} kcal</span><button class="primary-btn small" onclick="logFood('${food.zh.replace(/'/g, "\\'")}', ${food.cal})" style="padding:2px 8px;">+</button></div>`;
                foodSearchResults.appendChild(div);
            });
        }

        // 4. è¨˜éŒ„é£Ÿç‰©
        window.logFood = function(name, cal) {
            const newId = todayFoods.length > 0 ? Math.max(...todayFoods.map(f => f.id)) + 1 : 1;
            todayFoods.push({ id: newId, name: name, cal: parseFloat(cal) });
            localStorage.setItem('todayFoods', JSON.stringify(todayFoods));
            showToast(`${name} added!`);
            updateDashboard();
        }

        // 5. åˆªé™¤é£Ÿç‰©
        window.deleteFood = function(id) {
            todayFoods = todayFoods.filter(f => f.id !== id);
            localStorage.setItem('todayFoods', JSON.stringify(todayFoods));
            showToast('Item deleted!');
            updateDashboard();
        }

        // 6. æ¸…é™¤æ‰€æœ‰é£Ÿç‰©ç´€éŒ„
        window.clearFoodLog = function() {
            if(confirm('Are you sure you want to clear today\'s food log?')) {
                todayFoods = [];
                localStorage.removeItem('todayFoods');
                showToast('Log Cleared!');
                updateDashboard();
            }
        }

        // 7. è¼‰å…¥ä»Šæ—¥é£Ÿç‰©ç´€éŒ„
        function loadFoodLog() {
            todayFoods = JSON.parse(localStorage.getItem('todayFoods') || '[]');
        }

        // 8. æ›´æ–°å„€è¡¨æ¿é¡¯ç¤º (è¨ˆç®—ç¸½ç†±é‡å’Œé€²åº¦æ¢)
        function updateDashboard() {
            const tdee = parseFloat(localStorage.getItem('tdee') || 2000); // å‡è¨­å¾ profile è¼‰å…¥ TDEEï¼Œé è¨­ 2000
            
            const displayTotal = document.getElementById('current-cal');
            const targetDisplay = document.getElementById('target-cal');
            const progressBar = document.getElementById('progress-bar');
            const statusText = document.getElementById('status-text');

            const total = todayFoods.reduce((acc, f) => acc + f.cal, 0);
            displayTotal.textContent = total.toFixed(1);
            localStorage.setItem('todayCalories', total);

            targetDisplay.textContent = tdee;
            const pct = Math.min(100, (total / tdee) * 100);
            progressBar.style.width = pct + "%";
            
            if(total > tdee) {
                statusText.textContent = "(Surplus âš ï¸)";
                statusText.style.color = "red";
                progressBar.style.background = "red";
            } else {
                statusText.textContent = "(On Track)";
                statusText.style.color = "green";
                progressBar.style.background = "#e67e22";
            }

            foodLog.innerHTML = '';
            if (todayFoods.length === 0) {
                foodLog.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">No food logged yet.</div>';
                return;
            }

            todayFoods.forEach(f => {
                const div = document.createElement('div');
                div.className = 'food-list-item';
                // ç¢ºä¿å¡è·¯é‡Œé¡¯ç¤ºç‚ºä¸€ä½å°æ•¸
                div.innerHTML = `<div><div style="font-weight:bold;">${f.name}</div></div><div style="display:flex; align-items:center; gap:10px;"><span style="color:#e67e22; font-weight:bold;">${f.cal.toFixed(1)} kcal</span><button class="danger-btn small" onclick="deleteFood(${f.id})" style="padding:2px 8px;">Ã—</button></div>`;
                foodLog.appendChild(div);
            });
        }
    </script>
</body>
</html>